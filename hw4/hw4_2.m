clear;clc;close;
s=[0.076155042	-0.154324919	-9.798488875;
0.150666382	-0.309391256	-9.793956131;
0.223502869	-0.465134188	-9.786403663;
0.294634056	-0.621488607	-9.775834629;
0.364030205	-0.77838915	-9.762253446;
0.431662308	-0.935770225	-9.745665792;
0.497502089	-1.093566042	-9.726078603;
0.561522026	-1.251710633	-9.703500065;
0.623695356	-1.410137888	-9.677939618;
0.683996086	-1.568781577	-9.649407946;
0.74239901	-1.72757538	-9.617916979;
0.798879711	-1.886452915	-9.58347988;
0.853414578	-2.045347764	-9.546111045;
0.905980815	-2.204193501	-9.505826096;
0.956556444	-2.362923722	-9.462641875;
1.005120325	-2.521472071	-9.416576433;
1.051652154	-2.679772269	-9.367649029;
1.09613248	-2.837758138	-9.315880116;
1.138542707	-2.995363633	-9.261291336;
1.178865107	-3.152522869	-9.203905509;
1.217082823	-3.309170146	-9.143746625;
1.253179878	-3.465239978	-9.080839834;
1.287141183	-3.620667123	-9.015211432;
1.318952539	-3.775386603	-8.946888856;
1.348600648	-3.929333741	-8.875900667;
1.376073117	-4.082444178	-8.802276541;
1.401358459	-4.234653909	-8.726047257;
1.424446106	-4.385899303	-8.647244682;
1.445326405	-4.536117133	-8.565901759;
1.463990628	-4.685244601	-8.482052492;
1.480430972	-4.833219365	-8.395731934;
1.494640564	-4.979979566	-8.306976171;
1.506613464	-5.125463851	-8.215822307;
1.516344666	-5.269611402	-8.122308448;
1.523830104	-5.412361958	-8.026473687;
1.529066647	-5.553655843	-7.928358087;
1.532052106	-5.693433992	-7.828002665;
1.532785234	-5.831637969	-7.725449374;
1.531265723	-5.968210001	-7.620741084;
1.52749421	-6.103092993	-7.51392157;
1.52147227	-6.236230558	-7.405035486;
1.513202422	-6.367567041	-7.294128352;
1.502688121	-6.497047535	-7.181246531;
1.489933765	-6.624617913	-7.066437213;
1.474944684	-6.750224845	-6.949748393;
1.457727145	-6.873815821	-6.831228852;
1.438288346	-6.995339175	-6.710928137;
1.416636412	-7.114744105	-6.588896539;
1.392780395	-7.231980694	-6.465185072;
1.366730268	-7.346999932	-6.339845453;
1.338496921	-7.459753737	-6.212930079;
1.308092158	-7.570194973	-6.084492007;
1.275528687	-7.678277469	-5.954584929;
1.240820123	-7.783956043	-5.823263153;
1.203980975	-7.887186517	-5.690581575;
1.165026643	-7.987925735	-5.556595664;
1.123973413	-8.086131585	-5.421361431;
1.080838445	-8.181763011	-5.28493541;
1.035639773	-8.274780037	-5.147374632;
0.988396291	-8.365143776	-5.008736605;
0.93912775	-8.452816453	-4.869079285;
0.887854745	-8.537761416	-4.728461055;
0.834598711	-8.619943156	-4.5869407;
0.779381911	-8.699327316	-4.44457738;
0.722227429	-8.77588071	-4.301430611;
0.663159158	-8.849571336	-4.157560234;
0.602201789	-8.920368388	-4.013026393;
0.539380808	-8.988242269	-3.86788951;
0.474722474	-9.053164605	-3.722210257;
0.408253819	-9.115108257	-3.576049536;
0.340002629	-9.174047328	-3.429468448;
0.269997436	-9.22995718	-3.28252827;
0.198267506	-9.28281444	-3.135290429;
0.124842824	-9.332597011	-2.987816478;
0.049754086	-9.379284081	-2.840168067;
-0.026967319	-9.422856135	-2.69240692;
-0.105289317	-9.463294956	-2.544594807;
-0.185179167	-9.50058364	-2.39679352;
-0.26660347	-9.534706598	-2.249064846;
-0.349528189	-9.565649565	-2.101470543;
-0.433918656	-9.593399606	-1.954072311;
-0.519739593	-9.61794512	-1.80693177;
-0.606955124	-9.639275846	-1.66011043;
-0.695528787	-9.657382867	-1.513669669;
-0.785423556	-9.672258613	-1.367670706;
-0.876601851	-9.683896866	-1.222174575;
-0.969025554	-9.692292759	-1.077242099;
-1.062656029	-9.697442785	-0.932933867;
-1.157454135	-9.699344788	-0.789310206;
-1.253380241	-9.697997975	-0.646431157;
-1.350394246	-9.693402909	-0.504356449;
-1.448455595	-9.685561509	-0.363145476;
-1.547523292	-9.674477056	-0.22285727;
-1.647555924	-9.660154181	-0.083550478;
-1.748511673	-9.642598873	0.054716663;
-1.850348334	-9.62181847	0.191886353;
-1.953023335	-9.59782166	0.327901248;
-2.056493755	-9.570618475	0.462704488;
-2.160716336	-9.540220286	0.596239719;
-2.265647511	-9.506639802	0.728451118;];

q=[1;0;0;0];



%e = @(q ,s) [-2*9.8*(q(2)*q(4) - q(1)*q(3)) - s(1);
%                -2*9.8*(q(1)*q(2) + q(3)*q(4)) - s(2);
 %              -2*9.8*(0.5 - q(2)^2 - q(3)^2) - s(3)];
           
%J =@(q) -9.8.*[-2*q(3),	2*q(4),    -2*q(1),	2*q(2);
  %               2*q(2),     2*q(1),     2*q(4),	2*q(3);
  %              0,         -4*q(2),    -4*q(3),	0    ];

u=1;
q_matrix=[];

            
for i=1:100
    
    for j=1:10000
        
        E=[-2*9.8*(q(2)*q(4) - q(1)*q(3)) - s(i,1);
            -2*9.8*(q(1)*q(2) + q(3)*q(4)) - s(i,2);
            -2*9.8*(0.5 - q(2)^2 - q(3)^2) - s(i,3)]; 

        J=-9.8.*[-2*q(3), 2*q(4), -2*q(1), 2*q(2);
                 2*q(2), 2*q(1), 2*q(4), 2*q(3);
                 0, -4*q(2), -4*q(3), 0];
        C=E'*E;
        grad_c=J'*E;

        
        %BLC
        alpha = 0.5;
        beta =  0.707;
        Q= [q(1)-u*grad_c(1)  q(2)-u*grad_c(2)  q(3)-u*grad_c(3) q(4)-u*grad_c(4)];
        E_new=[-2*9.8*(Q(2)*Q(4) - Q(1)*Q(3)) - s(i,1);
            -2*9.8*(Q(1)*Q(2) + Q(3)*Q(4)) - s(i,2);
            -2*9.8*(0.5 - Q(2)^2 - Q(3)^2) - s(i,3)];
        c_new=E_new'*E_new;
        
        
        while c_new>C+alpha*u*(-grad_c'*grad_c)

            u = u*beta;
             Q= [q(1)-u*grad_c(1)  q(2)-u*grad_c(2)  q(3)-u*grad_c(3) q(4)-u*grad_c(4)];
        E_new=[-2*9.8*(Q(2)*Q(4) - Q(1)*Q(3)) - s(i,1);
            -2*9.8*(Q(1)*Q(2) + Q(3)*Q(4)) - s(i,2);
            -2*9.8*(0.5 - Q(2)^2 - Q(3)^2) - s(i,3)];
        c_new=E_new'*E_new;
        end
         %


        q = q - u.*grad_c/norm(grad_c);

    end
    q_matrix(:,i)=q;
end

for k=1:100

quat=quaternion(q_matrix(1 ,k),q_matrix(2 ,k),q_matrix(3 ,k),q_matrix(4 ,k));
rotationresul(k,:)= rotateframe(quat,[0,0,-9.8])';



end



